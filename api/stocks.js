const http = require('http');

// 按行业分类的股票列表（每个行业约30-50只）
const INDUSTRY_STOCKS = {
    // 科技股（50只）
    tech: [
        'sz300750','sz002594','sz002415','sz000725','sz300059','sz002230','sz002475','sz000063',
        'sz300014','sz300015','sz002241','sz002049','sz300124','sz300033','sz002236','sz300136',
        'sz002371','sz300253','sz300496','sz002405','sz300223','sz300274','sz002410','sz300017',
        'sz300408','sz002555','sz300347','sz300433','sz002153','sz300122','sz300212','sz002456',
        'sh688981','sh688012','sh688036','sh688111','sh688008','sh688009','sh688126','sh688099',
        'sz002938','sz300782','sz300760','sz300763','sz300773','sz300775','sz300777','sz300778',
        'sz002916','sz300724'
    ],
    // 金融股（50只）
    finance: [
        'sh600036','sh601318','sh600000','sh601398','sh601988','sh601166','sz000001','sh600030',
        'sh601688','sh601601','sh601328','sh601818','sh601229','sh601998','sh600016','sh600015',
        'sh601169','sh601009','sh600919','sh601288','sh601939','sh601658','sh601838','sh601577',
        'sh601878','sh601128','sh601860','sh601881','sh601066','sh601236','sh601377','sh601319',
        'sh601336','sh601211','sh600958','sh600999','sh600837','sh601555','sh601198','sh601901',
        'sh600109','sh601099','sh601108','sh601375','sh601360','sh601990','sh601997','sh601865',
        'sz000166','sz002142'
    ],
    // 消费股（50只）
    consumer: [
        'sh600519','sz000858','sz000333','sz000651','sh600887','sz000568','sz002304','sh603288',
        'sh600809','sh600600','sz000895','sz002714','sz000596','sh603369','sh600779','sz000869',
        'sh600132','sz002557','sz000729','sh600597','sh603517','sz002568','sh600298','sz000799',
        'sh600872','sz002507','sh600305','sz000848','sh603027','sz002847','sh600300','sz000860',
        'sh600073','sz002216','sh600429','sz000423','sh603198','sz002650','sh600882','sz000876',
        'sh600186','sz002746','sh600616','sz000930','sh600438','sz002583','sh600199','sz000639',
        'sh600600','sz002385'
    ],
    // 医药股（50只）
    healthcare: [
        'sh600276','sz000538','sh600196','sz300760','sh600436','sz002007','sz300122','sh600867',
        'sz000963','sh603259','sz002422','sz300347','sz002252','sh600085','sz300003','sz002001',
        'sh600332','sz000661','sz002589','sh600521','sz300015','sz002038','sz300529','sh600557',
        'sz002581','sh600812','sz300595','sz002773','sz300357','sh603882','sz002821','sz300558',
        'sh600079','sz002399','sz300009','sz002262','sz300142','sh600380','sz002603','sz300294',
        'sh600201','sz002727','sz300601','sh603127','sz002693','sz300759','sh600763','sz002030',
        'sh600566','sz300725'
    ],
    // 能源股（40只）
    energy: [
        'sh600900','sh601012','sh600011','sh601985','sh600886','sh601991','sh600025','sh600027',
        'sh601016','sh600795','sh600023','sh600021','sh600674','sh600578','sh600726','sh600863',
        'sh601619','sh600116','sh600236','sh600969','sh600310','sh600396','sh600509','sh600131',
        'sh600642','sh600979','sh600982','sh600995','sh601619','sh600505','sh600644','sh600780',
        'sz000027','sz000600','sz000690','sz000875','sz000883','sz000899','sz000966','sz000993'
    ],
    // 材料股（50只）
    material: [
        'sh600309','sh601899','sh600585','sz000423','sz002460','sz002466','sz000630','sh600219',
        'sh600426','sh601600','sh600176','sh600188','sh600989','sh601225','sh600497','sh600096',
        'sh600549','sh600884','sh600141','sh600516','sh600295','sh600459','sh600096','sh600160',
        'sh600111','sh600547','sh600489','sh600348','sh600352','sh600392','sh600409','sh600456',
        'sz000709','sz000825','sz000878','sz000898','sz000932','sz000960','sz000969','sz002080',
        'sz002129','sz002192','sz002203','sz002240','sz002324','sz002340','sz002353','sz002358',
        'sz002373','sz002386'
    ],
    // 工业股（50只）
    industrial: [
        'sh600031','sh601668','sh601390','sh600048','sz002352','sh601100','sz000002','sh601186',
        'sh600104','sh601766','sh601111','sh600009','sh600115','sh600118','sh600125','sh600150',
        'sh600153','sh600169','sh600170','sh600177','sh600190','sh600208','sh600221','sh600231',
        'sh600252','sh600256','sh600261','sh600266','sh600269','sh600271','sh600280','sh600282',
        'sz000039','sz000060','sz000089','sz000157','sz000338','sz000400','sz000410','sz000425',
        'sz000528','sz000537','sz000550','sz000559','sz000581','sz000591','sz000598','sz000617',
        'sz000625','sz000629'
    ]
};

// 默认热门股票（混合各行业）
const HOT_STOCKS = [
    'sh600519','sz000858','sz300750','sz002594','sz000333','sz000651','sh600036','sh601318',
    'sz000725','sz002415','sh600000','sh601398','sh601988','sh600030','sz000001','sh600276',
    'sh600887','sz000568','sz002304','sh600900','sh601012','sh600309','sh601899','sh600031',
    'sz002475','sh601166','sz000063','sz002352','sh603288','sh600809','sz300059','sz002230',
    'sz000538','sh600196','sh601668','sh601390','sh600048','sh600011','sh601985','sh600585',
    'sz000423','sz002460','sh600219','sh601100','sz000630','sz002466','sh600426','sh601688',
    'sh601601','sh601328'
];

// 股票名称映射
const STOCK_NAMES = {
    '600519':'贵州茅台','000858':'五粮液','300750':'宁德时代','002594':'比亚迪',
    '000333':'美的集团','000651':'格力电器','600036':'招商银行','601318':'中国平安',
    '000725':'京东方A','002415':'海康威视','600000':'浦发银行','601398':'工商银行',
    '601988':'中国银行','600030':'中信证券','000001':'平安银行','600276':'恒瑞医药',
    '600887':'伊利股份','000568':'泸州老窖','002304':'洋河股份','600900':'长江电力',
    '601012':'隆基绿能','600309':'万华化学','601899':'紫金矿业','600031':'三一重工',
    '002475':'立讯精密','601166':'兴业银行','000063':'中兴通讯','002352':'顺丰控股',
    '603288':'海天味业','600809':'山西汾酒','300059':'东方财富','002230':'科大讯飞',
    '000538':'云南白药','600196':'复星医药','601668':'中国建筑','601390':'中国中铁',
    '600048':'保利发展','600011':'华能国际','601985':'中国核电','600585':'海螺水泥',
    '000423':'东阿阿胶','002460':'赣锋锂业','600219':'南山铝业','601100':'恒立液压',
    '000630':'铜陵有色','002466':'天齐锂业','600426':'华鲁恒升','601688':'华泰证券',
    '601601':'中国太保','601328':'交通银行','000002':'万科A',
    '300014':'亿纬锂能','300015':'爱尔眼科','002241':'歌尔股份','002049':'紫光国微',
    '300124':'汇川技术','300033':'同花顺','002236':'大华股份','300136':'信维通信',
    '002371':'北方华创','300253':'卫宁健康','300496':'中科创达','002405':'四维图新',
    '300223':'北京君正','300274':'阳光电源','002410':'广联达','300017':'网宿科技',
    '688981':'中芯国际','688012':'中微公司','688036':'传音控股','688111':'金山办公',
    '688008':'澜起科技','688009':'中国通号','688126':'沪硅产业','688099':'晶晨股份',
    '601818':'光大银行','601229':'上海银行','601998':'中信银行','600016':'民生银行',
    '600015':'华夏银行','601169':'北京银行','601009':'南京银行','600919':'江苏银行',
    '601288':'农业银行','601939':'建设银行','601658':'邮储银行','601838':'成都银行',
    '601577':'长沙银行','601878':'浙商银行','601128':'常熟银行','601860':'紫金银行',
    '600600':'青岛啤酒','000895':'双汇发展','002714':'牧原股份','000596':'古井贡酒',
    '603369':'今世缘','600779':'水井坊','000869':'张裕A','600132':'重庆啤酒',
    '002557':'洽洽食品','000729':'燕京啤酒','600597':'光明乳业','603517':'绝味食品',
    '300760':'迈瑞医疗','600436':'片仔癀','002007':'华兰生物','600867':'通化东宝',
    '000963':'华东医药','603259':'药明康德','002422':'科伦药业','002252':'上海莱士',
    '600085':'同仁堂','300003':'乐普医疗','002001':'新和成','600332':'白云山',
    '600886':'国投电力','601991':'大唐发电','600025':'华能水电','600027':'华电国际',
    '601016':'节能风电','600795':'国电电力','600023':'浙能电力','600021':'上海电力',
    '601600':'中国铝业','600176':'中国巨石','600188':'兖矿能源','600989':'宝丰能源',
    '601225':'陕西煤业','600497':'驰宏锌锗','600096':'云天化','600549':'厦门钨业',
    '601186':'中国铁建','600104':'上汽集团','601766':'中国中车','601111':'中国国航',
    '600009':'上海机场','600115':'东方航空','600118':'中国卫星','600125':'铁龙物流'
};

module.exports = async (req, res) => {
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Content-Type', 'application/json; charset=utf-8');
    if (req.method === 'OPTIONS') return res.status(200).end();

    try {
        const url = new URL(req.url, `http://${req.headers.host}`);
        const industry = url.searchParams.get('industry');
        const limit = parseInt(url.searchParams.get('limit')) || 50;
        
        let stockList;
        if (industry && INDUSTRY_STOCKS[industry]) {
            stockList = INDUSTRY_STOCKS[industry].slice(0, Math.min(limit, 50));
        } else {
            stockList = HOT_STOCKS.slice(0, Math.min(limit, 50));
        }
        
        const codes = stockList.join(',');
        const data = await fetchSinaData(codes);
        
        const stocks = [];
        for (const code of stockList) {
            const info = data[code];
            if (info && info.price > 0) {
                const shortCode = code.substring(2);
                stocks.push({
                    code: shortCode,
                    name: STOCK_NAMES[shortCode] || shortCode,
                    price: info.price,
                    change: info.change,
                    pe: 0, pb: 0, roe: 0,
                    volume: info.volume,
                    amount: info.amount,
                    high: info.high,
                    low: info.low,
                    open: info.open,
                    industry: industry || getIndustry(shortCode)
                });
            }
        }

        stocks.sort((a, b) => b.volume - a.volume);

        res.status(200).json({ 
            success: true, 
            data: stocks, 
            count: stocks.length,
            industry: industry || 'all',
            timestamp: new Date().toISOString()
        });
    } catch (error) {
        res.status(200).json({ success: false, error: error.message, data: [] });
    }
};

function fetchSinaData(codes) {
    return new Promise((resolve, reject) => {
        const url = `http://hq.sinajs.cn/list=${codes}`;
        http.get(url, { headers: { 'Referer': 'http://finance.sina.com.cn' } }, (resp) => {
            const chunks = [];
            resp.on('data', chunk => chunks.push(chunk));
            resp.on('end', () => {
                try {
                    const buffer = Buffer.concat(chunks);
                    const data = buffer.toString('utf-8');
                    const result = {};
                    const lines = data.split('\n');
                    for (const line of lines) {
                        if (!line.includes('=')) continue;
                        const match = line.match(/hq_str_(\w+)="(.*)"/);
                        if (match) {
                            const code = match[1];
                            const values = match[2].split(',');
                            if (values.length > 30) {
                                const yclose = parseFloat(values[2]) || 0;
                                const price = parseFloat(values[3]) || 0;
                                result[code] = {
                                    open: parseFloat(values[1]) || 0,
                                    price: price,
                                    high: parseFloat(values[4]) || 0,
                                    low: parseFloat(values[5]) || 0,
                                    volume: parseFloat(values[8]) || 0,
                                    amount: parseFloat(values[9]) || 0,
                                    change: yclose > 0 ? ((price - yclose) / yclose * 100) : 0
                                };
                            }
                        }
                    }
                    resolve(result);
                } catch (e) { reject(e); }
            });
        }).on('error', reject);
    });
}

function getIndustry(code) {
    const ind = {
        '600036':'finance','601318':'finance','600000':'finance','601398':'finance','601988':'finance',
        '601166':'finance','000001':'finance','600030':'finance','601688':'finance','601601':'finance','601328':'finance',
        '601818':'finance','601229':'finance','601998':'finance','600016':'finance','600015':'finance',
        '601169':'finance','601009':'finance','600919':'finance','601288':'finance','601939':'finance',
        '600519':'consumer','000858':'consumer','000333':'consumer','000651':'consumer','600887':'consumer',
        '000568':'consumer','002304':'consumer','603288':'consumer','600809':'consumer','600600':'consumer',
        '000895':'consumer','002714':'consumer','000596':'consumer','603369':'consumer','600779':'consumer',
        '300750':'tech','002594':'tech','002415':'tech','000725':'tech','300059':'tech','002230':'tech','002475':'tech','000063':'tech',
        '300014':'tech','300015':'tech','002241':'tech','002049':'tech','300124':'tech','300033':'tech','002236':'tech',
        '688981':'tech','688012':'tech','688036':'tech','688111':'tech','688008':'tech',
        '600276':'healthcare','000538':'healthcare','600196':'healthcare','300760':'healthcare','600436':'healthcare',
        '002007':'healthcare','600867':'healthcare','000963':'healthcare','603259':'healthcare','002422':'healthcare',
        '600900':'energy','601012':'energy','600011':'energy','601985':'energy','600886':'energy',
        '601991':'energy','600025':'energy','600027':'energy','601016':'energy','600795':'energy',
        '600309':'material','601899':'material','600585':'material','000423':'material','002460':'material',
        '002466':'material','000630':'material','600219':'material','600426':'material','601600':'material',
        '600176':'material','600188':'material','600989':'material','601225':'material',
        '600031':'industrial','601668':'industrial','601390':'industrial','600048':'industrial','002352':'industrial',
        '601100':'industrial','000002':'industrial','601186':'industrial','600104':'industrial','601766':'industrial'
    };
    return ind[code] || 'other';
}
